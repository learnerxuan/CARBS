<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CARBS - Admin Resource Availability</title>
  <link rel="stylesheet" href="css/global.css" />
  <link rel="stylesheet" href="css/footer.css" />
  <link rel="stylesheet" href="css/availability.css" />
  <style>
    .availability-legend {
      margin-top: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 0.95em;
    }

    .legend-item {
      padding: 6px 16px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9em;
    }

    .legend-item.available {
      background-color: #28a745;
      color: white;
    }

    .legend-item.occupied {
      background-color: #dc3545;
      color: white;
    }

    .control-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      margin-bottom: 30px;
    }

    .control-buttons .btn {
      padding: 12px 24px;
      font-size: 1em;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .mark-occupied {
      background-color: #dc3545;
      color: white;
    }

    .mark-available {
      background-color: #28a745;
      color: white;
    }

    .time-slot.selected {
      outline: 3px solid #007bff;
    }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>
  <main>
    <section class="availability-container">
      <h2>Real-Time Resource Availability</h2>
      <p class="section-description">
        Select a date to view the real-time availability of all resources and
        details of confirmed bookings.
      </p>

      <div class="date-selector">
        <label for="selectDay">Day:</label>
        <select id="selectDay"></select>
        <label for="selectMonth">Month:</label>
        <select id="selectMonth"></select>
        <label for="selectYear">Year:</label>
        <select id="selectYear"></select>
        <button class="btn" id="checkDateBtn">Go</button>
      </div>

      <div class="availability-legend">
        <span>Legend:</span>
        <span class="legend-item available">Available</span>
        <span class="legend-item occupied">Occupied</span>
      </div>

      <div class="time-header-grid">
        <div class="resource-label-column"></div>
        <div class="time-slot-header">8 AM</div>
        <div class="time-slot-header">9 AM</div>
        <div class="time-slot-header">10 AM</div>
        <div class="time-slot-header">11 AM</div>
        <div class="time-slot-header">12 PM</div>
        <div class="time-slot-header">1 PM</div>
        <div class="time-slot-header">2 PM</div>
        <div class="time-slot-header">3 PM</div>
        <div class="time-slot-header">4 PM</div>
        <div class="time-slot-header">5 PM</div>
        <div class="time-slot-header">6 PM</div>
      </div>

      <div id="resourcesAvailability" class="resources-availability">
        <p class="initial-message">
          Select a date above to view resource availability.
        </p>
      </div>

      <div class="control-buttons">
        <button class="btn mark-occupied" id="markOccupiedBtn">Mark Occupied</button>
        <button class="btn mark-available" id="markAvailableBtn">Mark Available</button>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 CARBS. All rights reserved.</p>
  </footer>

  <script src="js/admin_load_header.js"></script>
  <script src="js/data.js"></script>
  <script>
    const timeSlots = Array.from({ length: 11 }, (_, i) => {
      const hour = 8 + i;
      return `${String(hour).padStart(2, "0")}:00`;
    });

    const resourcesToShow = window.mockData.resources.map((res) => res.name);
    let selectedSlot = null;

    document.addEventListener("DOMContentLoaded", function () {
      const selectDay = document.getElementById("selectDay");
      const selectMonth = document.getElementById("selectMonth");
      const selectYear = document.getElementById("selectYear");
      const checkDateBtn = document.getElementById("checkDateBtn");
      const resourcesAvailabilityDiv = document.getElementById("resourcesAvailability");
      const markOccupiedBtn = document.getElementById("markOccupiedBtn");
      const markAvailableBtn = document.getElementById("markAvailableBtn");

      for (let i = 1; i <= 31; i++) {
        selectDay.innerHTML += `<option value="${String(i).padStart(2, "0")}">${i}</option>`;
      }

      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      months.forEach((month, index) => {
        selectMonth.innerHTML += `<option value="${String(index + 1).padStart(2, "0")}">${month}</option>`;
      });

      const currentYear = new Date().getFullYear();
      for (let i = currentYear - 1; i <= currentYear + 2; i++) {
        selectYear.innerHTML += `<option value="${i}">${i}</option>`;
      }

      const today = new Date();
      selectDay.value = String(today.getDate()).padStart(2, "0");
      selectMonth.value = String(today.getMonth() + 1).padStart(2, "0");
      selectYear.value = String(today.getFullYear());

      checkDateBtn.addEventListener("click", displayAvailability);
      markOccupiedBtn.addEventListener("click", () => updateSlotStatus("occupied"));
      markAvailableBtn.addEventListener("click", () => updateSlotStatus("available"));

      displayAvailability();

      function displayAvailability() {
        selectedSlot = null;
        const selectedDate = `${selectYear.value}-${selectMonth.value}-${selectDay.value}`;
        resourcesAvailabilityDiv.innerHTML = "";

        resourcesToShow.forEach((resourceName) => {
          const resourceRow = document.createElement("div");
          resourceRow.classList.add("resource-row");

          const resourceNameDiv = document.createElement("div");
          resourceNameDiv.classList.add("resource-name");
          resourceNameDiv.textContent = resourceName;
          resourceRow.appendChild(resourceNameDiv);

          timeSlots.forEach((slotTime) => {
            const timeSlotDiv = document.createElement("div");
            timeSlotDiv.classList.add("time-slot", "available");

            const booking = window.mockData.resourceBookings.find(
              (b) =>
                b.resourceName === resourceName &&
                b.date === selectedDate &&
                slotTime >= b.startTime &&
                slotTime < b.endTime
            );

            if (booking) {
              timeSlotDiv.classList.remove("available");
              timeSlotDiv.classList.add("occupied");
              timeSlotDiv.title = `Booked by ${booking.bookedBy} (${booking.startTime}-${booking.endTime})`;
            }

            timeSlotDiv.addEventListener("click", function () {
              if (selectedSlot) selectedSlot.classList.remove("selected");
              timeSlotDiv.classList.add("selected");
              selectedSlot = timeSlotDiv;
            });

            resourceRow.appendChild(timeSlotDiv);
          });

          resourcesAvailabilityDiv.appendChild(resourceRow);
        });
      }

      function updateSlotStatus(status) {
        if (!selectedSlot) return;

        const resourceRow = selectedSlot.parentElement;
        const resourceName = resourceRow.querySelector('.resource-name').textContent;
        const selectedDate = `${selectYear.value}-${selectMonth.value}-${selectDay.value}`;
        const timeIndex = Array.from(selectedSlot.parentElement.children).indexOf(selectedSlot) - 1;
        const slotTime = timeSlots[timeIndex];

        selectedSlot.classList.remove("available", "occupied");
        selectedSlot.classList.add(status);

        const existing = window.mockData.resourceBookings.find(
          (b) =>
            b.resourceName === resourceName &&
            b.date === selectedDate &&
            slotTime >= b.startTime &&
            slotTime < b.endTime
        );

        if (status === "occupied") {
          if (!existing) {
            window.mockData.resourceBookings.push({
              id: `book${String(window.mockData.resourceBookings.length + 1).padStart(3, '0')}`,
              resourceId: "res000",
              resourceName,
              date: selectedDate,
              startTime: slotTime,
              endTime: getNextSlotTime(slotTime),
              purpose: "Manual Booking",
              bookedBy: "Admin",
              priority: "low",
              status: "Approved"
            });
          }
        } else if (status === "available" && existing) {
          const index = window.mockData.resourceBookings.indexOf(existing);
          if (index !== -1) window.mockData.resourceBookings.splice(index, 1);
        }
      }

      function getNextSlotTime(time) {
        const [h, m] = time.split(":").map(Number);
        const date = new Date(2000, 0, 1, h + 1, m);
        return `${String(date.getHours()).padStart(2, "0")}:${String(date.getMinutes()).padStart(2, "0")}`;
      }
    });
  </script>
</body>
</html>
